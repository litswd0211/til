## ğŸ”” Web Push Notifications + VAPID å®Ÿè£…ã‚¬ã‚¤ãƒ‰

### âœ… ã¯ã˜ã‚ã«

Web Pushé€šçŸ¥ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒPushã‚µãƒ¼ãƒãƒ¼ã‚’è³¼èª­ã—ã€ã‚µãƒ¼ãƒãƒ¼ãŒé€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚
**VAPID**ï¼ˆVoluntary Application Server Identificationï¼‰ã¯é€šçŸ¥é€ä¿¡è€…ã®æ­£å½“æ€§ã‚’ç¤ºã™ãŸã‚ã®èªè¨¼æ–¹å¼ã§ã™ã€‚

---

### ğŸ“‹ ãƒ•ãƒ­ãƒ¼æ¦‚è¦

```text
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å…¬é–‹éµã‚’å–å¾—
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã®è¨±å¯ã‚’æ±‚ã‚ã‚‹
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯Pushã‚µãƒ¼ãƒãƒ¼ã‚’è³¼èª­
4. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è³¼èª­æƒ…å ±ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
5. ã‚µãƒ¼ãƒãƒ¼ã¯Pushã‚µãƒ¼ãƒãƒ¼ã¸é€šçŸ¥ã‚’é€ä¿¡
```

---

### ğŸ”‘ VAPIDã«ã¤ã„ã¦

| é …ç›®      | å†…å®¹                      |
| ------- | ----------------------- |
| ç™ºè¡Œè€… | Pushé€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼å´        |
| å…¬é–‹éµ     | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ¸¡ã—Pushè³¼èª­ã«ä½¿ç”¨      |
| ç§˜å¯†éµ     | ã‚µãƒ¼ãƒãƒ¼å´ã®Pushé€šçŸ¥ã®ç½²åã«ä½¿ç”¨ï¼ˆæµå‡ºç¦æ­¢ï¼‰ |
| åˆ©ç”¨æ–¹æ³•     | VAPIDã®éµã¯ä¸€åº¦ç”Ÿæˆã™ã‚Œã°å†åˆ©ç”¨å¯èƒ½     |

---

### ğŸ’» å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«

#### HTML / JavaScript (index.html)

```js
const PUBLIC_VAPID_KEY = '...';

const permission = await Notification.requestPermission();
if (permission === 'granted') {
  const registration = await navigator.serviceWorker.register('/sw.js');
  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: Uint8Array.from(atob(PUBLIC_VAPID_KEY), c => c.charCodeAt(0))
  });

  await fetch('/subscribe', {
    method: 'POST',
    body: JSON.stringify(subscription),
    headers: { 'Content-Type': 'application/json' }
  });
}
```

#### Service Worker (sw.js)

```js
self.addEventListener('push', event => {
  const data = event.data.json();
  self.registration.showNotification(data.title, {
    body: data.body,
    icon: data.icon || '/icon.png'
  });
});
```

#### Node.js Server

```js
const webpush = require('web-push');
webpush.setVapidDetails('mailto:you@example.com', publicKey, privateKey);

app.post('/subscribe', (req, res) => {
  subscriptions.push(req.body); // DBã«ä¿å­˜
  res.sendStatus(201);
});

app.get('/send', async (req, res) => {
  for (const sub of subscriptions) {
    await webpush.sendNotification(sub, JSON.stringify({
      title: 'Push!',
      body: 'Test Message'
    }));
  }
  res.send('Sent');
});
```

---

### ğŸ“Š ä»•çµ„ã¿å›³

```text
[Client]
  â”œâ”€ (1) å…¬é–‹éµã‚’å–å¾—
  â”œâ”€ (2) Notification.requestPermission()
  â”œâ”€ (3) pushManager.subscribe() â†’ è³¼èª­æƒ…å ±
  â””â”€ (4) ã‚µãƒ¼ãƒãƒ¼ã¸POST

[Server]
  â””â”€ (5) è³¼èª­æƒ…å ±ã‚’å…ƒã«Pushé€ä¿¡
```

---

### ğŸ“ è£œè¶³èª¬æ˜

* **Pushã‚µãƒ¼ãƒãƒ¼**: ãƒ–ãƒ©ã‚¦ã‚¶æä¾›ã®Push Serviceï¼ˆChromeãªã‚‰FCMï¼‰
* **VAPID**: JWTç½²åã‚’ç”¨ã„ã¦Pushã‚µãƒ¼ãƒãƒ¼ã¸è‡ªåˆ†ã‚’è¨¼æ˜
* **ç§˜å¯†éµ**: å…¬é–‹ã—ã¦ã¯ã„ã‘ãªã„
* **Pushé…ä¿¡**: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã§ã‚‚å°‚ç”¨ã‚­ãƒ¥ãƒ¼ã§ä¿ç®¡ã•ã‚Œã‚‹

---

### ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

* [MDN Web Push API](https://developer.mozilla.org/ja/docs/Web/API/Push_API)
* [web-push NPM](https://www.npmjs.com/package/web-push)
* [Google Web Fundamentals - Push Notifications](https://developers.google.com/web/fundamentals/push-notifications)

---

## ğŸ§  ã¾ã¨ã‚

| ç”¨é€”           | é‡è¦ãƒã‚¤ãƒ³ãƒˆ     |
| ------------ | ------------ |
| VAPIDèªè¨¼ | å…¬é–‹éµãƒ»ç§˜å¯†éµã®é©åˆ‡ãªç®¡ç† |
| Pushé€šçŸ¥ | Service Workerã§ã®å—ä¿¡å‡¦ç† |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | ç§˜å¯†éµã®æµå‡ºé˜²æ­¢ |

---
